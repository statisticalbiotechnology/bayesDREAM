name: Build and Publish Apptainer

on:
  push:
    branches:
      - "**"
    tags:
      - "*"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  DEF_FILE: apptainer/bayesdream_cpu.def
  SIF_FILE: bayesdream_cpu.sif

jobs:
  build-and-push:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            # GitHub-hosted ARM64 Linux runner
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Apptainer
        run: |
          sudo apt-get update
          if apt-cache show apptainer >/dev/null 2>&1; then
            sudo apt-get install -y apptainer
          else
            # Ubuntu 24.04 (noble) does not ship an `apptainer` package.
            # Use singularity-container (compatible CLI) and provide an apptainer shim.
            sudo apt-get install -y singularity-container
            sudo ln -sf "$(command -v singularity)" /usr/local/bin/apptainer
          fi
          apptainer --version

      - name: Build SIF from definition
        run: |
          test -f "$DEF_FILE"
          sudo apptainer build "$SIF_FILE" "$DEF_FILE"
          sudo chown "$USER":"$USER" "$SIF_FILE"
          ls -lh "$SIF_FILE"

      - name: Install ORAS
        run: |
          ORAS_VERSION="1.2.2"
          ORAS_ARCH="${{ matrix.arch }}"
          curl -sSL "https://github.com/oras-project/oras/releases/download/v${ORAS_VERSION}/oras_${ORAS_VERSION}_linux_${ORAS_ARCH}.tar.gz" -o oras.tar.gz
          tar -xzf oras.tar.gz oras
          sudo install oras /usr/local/bin/oras
          oras version

      - name: Compute image refs
        id: refs
        shell: bash
        run: |
          set -euo pipefail

          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          REPO_LC="$(basename "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          REPO_BASE="ghcr.io/${OWNER_LC}/${REPO_LC}-apptainer"
          ARCH="${{ matrix.arch }}"

          SHA_SHORT="${GITHUB_SHA::12}"
          BRANCH_SAFE="$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | tr '/_' '-' | tr -cd 'a-z0-9.-')"

          echo "repo_base=${REPO_BASE}" >> "$GITHUB_OUTPUT"
          echo "sha_ref=${REPO_BASE}:cpu-${ARCH}-sha-${SHA_SHORT}" >> "$GITHUB_OUTPUT"
          echo "branch_ref=${REPO_BASE}:cpu-${ARCH}-${BRANCH_SAFE}" >> "$GITHUB_OUTPUT"
          echo "latest_ref=${REPO_BASE}:cpu-${ARCH}-latest" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        env:
          CR_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$CR_PAT" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Push SHA tag
        run: |
          oras push "${{ steps.refs.outputs.sha_ref }}" \
            --artifact-type application/vnd.sylabs.sif.config.v1+json \
            "${SIF_FILE}:application/vnd.sylabs.sif.layer.v1.sif"

      - name: Push branch tag
        if: startsWith(github.ref, 'refs/heads/')
        run: |
          oras push "${{ steps.refs.outputs.branch_ref }}" \
            --artifact-type application/vnd.sylabs.sif.config.v1+json \
            "${SIF_FILE}:application/vnd.sylabs.sif.layer.v1.sif"

      - name: Push latest tag on default branch
        if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        run: |
          oras push "${{ steps.refs.outputs.latest_ref }}" \
            --artifact-type application/vnd.sylabs.sif.config.v1+json \
            "${SIF_FILE}:application/vnd.sylabs.sif.layer.v1.sif"

      - name: Upload SIF as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: bayesdream-cpu-sif-${{ matrix.arch }}
          path: ${{ env.SIF_FILE }}
          if-no-files-found: error
