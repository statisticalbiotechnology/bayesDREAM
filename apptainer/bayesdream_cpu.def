Bootstrap: docker
From: python:3.11-slim

%labels
    Author bayesDREAM Development Team
    Description bayesDREAM CPU container for CLI and Snakemake workflows

%help
    Build:
      apptainer build bayesdream_cpu.sif apptainer/bayesdream_cpu.def

    Run CLI:
      apptainer exec bayesdream_cpu.sif bayesdream --help
      apptainer exec bayesdream_cpu.sif bayesdream run --config /work/config.yaml

    Snakemake usage example:
      snakemake --use-singularity --singularity-args "--bind $PWD:/work"

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export PYTHONUNBUFFERED=1
    export OMP_NUM_THREADS=1
    export OPENBLAS_NUM_THREADS=1
    export MKL_NUM_THREADS=1
    export NUMEXPR_NUM_THREADS=1

%files
    . /opt/bayesDREAM

%post
    set -eux

    apt-get update
    apt-get install -y --no-install-recommends \
        git \
        ca-certificates \
        tini
    rm -rf /var/lib/apt/lists/*

    python -m pip install --upgrade pip setuptools wheel

    # CPU torch wheel index to avoid GPU runtime assumptions inside container
    python -m pip install --no-cache-dir \
        --index-url https://download.pytorch.org/whl/cpu \
        torch torchvision torchaudio

    # Install bayesDREAM dependencies and Typer CLI deps
    python -m pip install --no-cache-dir \
        numpy \
        scipy \
        pandas \
        scikit-learn \
        pyro-ppl \
        matplotlib \
        seaborn \
        h5py \
        psutil \
        pyyaml \
        typer

    cd /opt/bayesDREAM
    python -m pip install --no-cache-dir -e .

%runscript
    cd /opt/bayesDREAM
    exec bayesdream "$@"

%test
    python -c "from bayesDREAM import bayesDREAM; print('bayesDREAM import ok')"
    bayesdream --help >/dev/null
